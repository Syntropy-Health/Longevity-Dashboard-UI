# Sync Secrets to GitHub
#
# This workflow syncs secrets from the repository to GitHub Actions.
# It's a helper workflow to manage secrets via code.
#
# Usage: Run manually via GitHub Actions UI
# Note: Requires a PAT with repo scope stored as ADMIN_PAT secret

name: Sync Secrets

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show what would be synced)'
        required: false
        default: false
        type: boolean

jobs:
  sync:
    name: Sync Repository Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show secrets to sync
        run: |
          echo "## Secrets Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following secrets should be configured:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret | Source | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| RAILWAY_TOKEN | Railway Dashboard | Deployment token from railway.app/account/tokens |" >> $GITHUB_STEP_SUMMARY
          echo "| OPENAI_API_KEY | .env.secrets | OpenAI API key for LLM features |" >> $GITHUB_STEP_SUMMARY
          echo "| CALL_API_TOKEN | .env.secrets | Call logs API authentication |" >> $GITHUB_STEP_SUMMARY
          echo "| REFLEX_DB_URL | .env.prod | Production database URL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manual Sync Command" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "./scripts/sync_github_secrets.sh Healome/longevity_clinic" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Verify required secrets exist
        run: |
          echo "Checking required secrets..."
          
          missing=()
          
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            missing+=("RAILWAY_TOKEN")
          fi
          
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            missing+=("OPENAI_API_KEY")
          fi
          
          if [ -z "${{ secrets.CALL_API_TOKEN }}" ]; then
            missing+=("CALL_API_TOKEN")
          fi
          
          if [ ${#missing[@]} -gt 0 ]; then
            echo "⚠️ Missing secrets: ${missing[*]}"
            echo ""
            echo "To add missing secrets, run locally:"
            echo "  ./scripts/sync_github_secrets.sh Healome/longevity_clinic"
            exit 1
          fi
          
          echo "✓ All required secrets are configured"
