# Deploy to Railway
#
# Automatic deployment workflow for Longevity Clinic.
# Triggers:
#   - Push to main branch (auto-deploy to test)
#   - Manual trigger via GitHub Actions UI (workflow_dispatch)
#
# Prerequisites:
# 1. Add secrets to repository (Settings > Secrets > Actions):
#    - RAILWAY_TOKEN: Railway API token (https://railway.app/account/tokens)
#    - OPENAI_API_KEY: OpenAI API key for backend
#    - CALL_API_TOKEN: Call logs API token for backend
#    - REFLEX_DB_URL: (optional) Database URL if not using Railway Postgres
#
# 2. Ensure Railway project "syntropy" exists with services:
#    - longevity-clinic-backend
#    - longevity-clinic (frontend)

name: Deploy to Railway

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - prod

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  lint:
    name: Lint (Ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run ruff check
        run: uv run ruff check

      - name: Run ruff format check
        run: uv run ruff format --check

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        run: uv run pytest tests/ -v --tb=short
        env:
          APP_ENV: test
          IS_DEMO: "true"

  deploy:
    name: Deploy to Railway (${{ github.event.inputs.environment || 'test' }})
    runs-on: ubuntu-latest
    needs: test
    environment: ${{ github.event.inputs.environment || 'test' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Validate secrets
        run: |
          missing=""
          [ -z "${{ secrets.RAILWAY_TOKEN }}" ] && missing="$missing RAILWAY_TOKEN"
          [ -z "${{ secrets.OPENAI_API_KEY }}" ] && missing="$missing OPENAI_API_KEY"
          [ -z "${{ secrets.CALL_API_TOKEN }}" ] && missing="$missing CALL_API_TOKEN"
          if [ -n "$missing" ]; then
            echo "âŒ Missing required secrets:$missing"
            echo "Add them in Settings > Secrets and variables > Actions"
            exit 1
          fi
          echo "âœ“ All required secrets configured"

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Make scripts executable
        run: |
          chmod +x scripts/deploy_longevity_clinic.sh
          chmod +x reflex-railway-deploy/deploy_all.sh
          chmod +x reflex-railway-deploy/functions/*.sh

      - name: Create secrets file
        run: |
          # Create .env.secrets from GitHub secrets (for deploy script)
          cat > envs/.env.secrets << EOF
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          CALL_API_TOKEN=${{ secrets.CALL_API_TOKEN }}
          EOF
          # Optional: override DB URL if provided
          if [ -n "${{ secrets.REFLEX_DB_URL }}" ]; then
            echo "REFLEX_DB_URL=${{ secrets.REFLEX_DB_URL }}" >> envs/.env.secrets
          fi
          echo "âœ“ Secrets file created"

      - name: Deploy to Railway
        run: ./scripts/deploy_longevity_clinic.sh ${{ github.event.inputs.environment || 'test' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CALL_API_TOKEN: ${{ secrets.CALL_API_TOKEN }}

      - name: Deployment Summary
        run: |
          ENV="${{ github.event.inputs.environment || 'test' }}"
          echo "## Deployment Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** $ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** syntropy" >> $GITHUB_STEP_SUMMARY
          echo "- **Services:** longevity-clinic-backend, longevity-clinic" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** https://longevity-clinic-${ENV}.up.railway.app" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend:** https://longevity-clinic-backend-${ENV}.up.railway.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View deployment at [Railway Dashboard](https://railway.app/project/syntropy)" >> $GITHUB_STEP_SUMMARY
