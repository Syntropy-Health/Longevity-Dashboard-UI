# Deploy to Railway
#
# Manual deployment workflow for Longevity Clinic.
# Triggered via GitHub Actions UI (workflow_dispatch).
#
# Prerequisites:
# 1. Add RAILWAY_TOKEN to repository secrets
#    - Go to https://railway.app/account/tokens
#    - Create a new token
#    - Add to GitHub: Settings > Secrets > Actions > New repository secret
#
# 2. Ensure Railway project "syntropy" exists with services:
#    - Postgres (database)
#    - longevity-clinic-backend
#    - longevity-clinic (frontend)

name: Deploy to Railway

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - prod

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        run: uv run pytest tests/ -v --tb=short
        env:
          APP_ENV: dev
          IS_DEMO: "true"

  deploy:
    name: Deploy to Railway (${{ inputs.environment }})
    runs-on: ubuntu-latest
    needs: test
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Verify Railway Token
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "âŒ RAILWAY_TOKEN is not set"
            echo "Please add RAILWAY_TOKEN to repository secrets"
            exit 1
          fi
          echo "âœ“ RAILWAY_TOKEN is configured"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Make scripts executable
        run: |
          chmod +x scripts/deploy_longevity_clinic.sh
          chmod +x reflex-railway-deploy/deploy_all.sh

      - name: Deploy to Railway
        run: ./scripts/deploy_longevity_clinic.sh ${{ inputs.environment }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CALL_API_TOKEN: ${{ secrets.CALL_API_TOKEN }}

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** syntropy" >> $GITHUB_STEP_SUMMARY
          echo "- **Services:** longevity-clinic-backend, longevity-clinic" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View deployment at [Railway Dashboard](https://railway.app/project/syntropy)" >> $GITHUB_STEP_SUMMARY
